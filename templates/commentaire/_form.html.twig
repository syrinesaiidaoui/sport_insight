<div class="comment-form" style="margin: 0; padding: 24px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px;">
    <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 20px; color: #1e293b; display: flex; align-items: center; gap: 8px;">
        ‚úçÔ∏è Ajouter un commentaire
    </h3>
    
    <style>
        .comment-textarea-group { margin-bottom: 20px; }
        .comment-textarea-group label { 
            display: block; 
            margin-bottom: 10px; 
            color: #334155; 
            font-weight: 600; 
            font-size: 15px; 
        }
        .comment-textarea-group input,
        .comment-textarea-group textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid #cbd5e1;
            border-radius: 10px;
            font-size: 15px;
            background: #fff;
            color: #1e293b;
            transition: all 0.2s;
        }
        .comment-textarea-group textarea { min-height: 120px; }
        .comment-textarea-group input:focus,
        .comment-textarea-group textarea:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
        }
        .btn-publish {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }
        .btn-publish:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2); }
        .btn-ai-form {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn-ai-form:hover { transform: translateY(-1px); opacity: 0.95; }
        .btn-like-stat {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
    
    <form method="post" action="{{ path('app_commentaire_new', {'annonce_id': annonce.id}) }}">
        <div class="comment-textarea-group">
            <label for="auteur_anonyme">Votre nom</label>
            {% if app.user %}
                <input type="text" id="auteur_anonyme" name="auteur_anonyme" value="{{ app.user.prenom }} {{ app.user.nom }}" readonly style="background: #f1f5f9;">
            {% else %}
                <input type="text" id="auteur_anonyme" name="auteur_anonyme" placeholder="Syrine Saidaoui">
            {% endif %}
        </div>

        <div class="comment-textarea-group">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <label for="contenu" style="margin: 0;">Partagez votre avis sur cette annonce</label>
                <div id="mod_status_{{ annonce.id }}">
                    <span id="badge_approved_{{ annonce.id }}" class="badge-success" style="display: none; background: #10b981; color: #fff;">‚úÖ APPROUV√â PAR IA</span>
                    <span id="badge_blocked_{{ annonce.id }}" class="badge-danger" style="display: none; background: #ef4444; color: #fff;">‚ùå CONTENU BLOQU√â</span>
                </div>
            </div>
            <textarea 
                id="contenu_{{ annonce.id }}"
                name="contenu" 
                required 
                placeholder="√âcrivez votre commentaire ici... Soyez constructif et respectueux üòä"
                oninput="debouncedCheck('{{ annonce.id }}')"
            ></textarea>
            <div id="mod_reason_{{ annonce.id }}" style="margin-top: 10px; font-size: 14px; color: #ef4444; font-weight: 600; display: none;"></div>
        </div>

        <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px;">
            <button type="submit" id="submit_{{ annonce.id }}" class="btn-publish">
                <span>üìñ</span> Publier
            </button>
            
            <button type="button" onclick="aiAction('ar')" class="btn-ai-form">Traduire en arabe</button>
            <button type="button" onclick="aiAction('en')" class="btn-ai-form">Traduire en anglais</button>
            
            <div style="display: flex; gap: 12px;">
                <button type="button" onclick="summarizeAction()" class="btn-ai-form" style="flex: 2;">R√©sumer</button>
                <div class="btn-like-stat" style="flex: 1; justify-content: center;">
                    <span>üëç</span> 0
                </div>
            </div>
        </div>

        <p style="color: #64748b; font-size: 13px; margin-bottom: 16px;">Les commentaires sont visibles imm√©diatement</p>

        <div style="margin-top: 24px; border-top: 1px solid #e2e8f0; padding-top: 20px;">
            <p style="margin-bottom: 10px; font-size: 15px;"><strong style="color: #1e293b;">R√©sum√© :</strong> <span id="res_display_{{ annonce.id }}" style="color: #475569;"></span></p>
            <p style="font-size: 15px;"><strong style="color: #1e293b;">Traduction :</strong> <span id="trad_display_{{ annonce.id }}" style="color: #475569;"></span></p>
        </div>
    </form>

    <script>
        let timeout = null;
        function debouncedCheck(annonceId) {
            clearTimeout(timeout);
            timeout = setTimeout(() => checkModeration(annonceId), 600);
        }

        function checkModeration(annonceId) {
            const text = document.getElementById('contenu_' + annonceId).value;
            const badgeContainer = document.getElementById('mod_status_' + annonceId);
            const badgeApp = document.getElementById('badge_approved_' + annonceId);
            const badgeBlock = document.getElementById('badge_blocked_' + annonceId);
            const reason = document.getElementById('mod_reason_' + annonceId);
            const submit = document.getElementById('submit_' + annonceId);

            if (!text.trim()) {
                badgeContainer.style.display = 'none';
                reason.style.display = 'none';
                return;
            }

            fetch('{{ path('app_commentaire_check') }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            })
            .then(res => res.json())
            .then(data => {
                badgeContainer.style.display = 'block';
                if (data.status === 'BLOCKED') {
                    badgeApp.style.display = 'none';
                    badgeBlock.style.display = 'inline-block';
                    reason.innerText = '‚ö†Ô∏è ' + data.reason;
                    reason.style.display = 'block';
                    submit.disabled = true;
                    submit.style.opacity = '0.5';
                    submit.style.cursor = 'not-allowed';
                } else {
                    badgeApp.style.display = 'inline-block';
                    badgeBlock.style.display = 'none';
                    reason.style.display = 'none';
                    submit.disabled = false;
                    submit.style.opacity = '1';
                    submit.style.cursor = 'pointer';
                }
            });
        }

        function aiAction(lang) {
            const textarea = document.getElementById('contenu_{{ annonce.id }}');
            const display = document.getElementById('trad_display_{{ annonce.id }}');
            const text = textarea.value;

            if (!text) return alert('Veuillez √©crire un message d\'abord');

            display.innerText = 'Chargement...';
            
            fetch('{{ path('app_api_traduire_texte') }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text, target: lang })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) display.innerText = 'Erreur: ' + data.error;
                else display.innerText = data.text;
            })
            .catch(err => display.innerText = 'Erreur technique');
        }

        function summarizeAction() {
            const textarea = document.getElementById('contenu_{{ annonce.id }}');
            const display = document.getElementById('res_display_{{ annonce.id }}');
            const text = textarea.value;

            if (!text) return alert('Veuillez √©crire un message d\'abord');

            display.innerText = 'Calcul en cours...';

            fetch('{{ path('app_api_resumer_texte') }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            })
            .then(res => res.json())
            .then(data => {
                display.innerText = data.summary;
            })
            .catch(err => display.innerText = 'Erreur technique');
        }
    </script>
</div>




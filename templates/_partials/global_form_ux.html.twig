<style>
    .si-toast-wrap {
        position: fixed;
        top: 18px;
        right: 18px;
        z-index: 2200;
        display: grid;
        gap: 10px;
        width: min(360px, calc(100vw - 36px));
    }

    .si-toast {
        border-radius: 12px;
        border: 1px solid #dbe3ea;
        background: #fff;
        padding: 12px 14px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.15);
        display: flex;
        align-items: flex-start;
        gap: 10px;
        animation: si-slide-in .2s ease-out;
    }

    .si-toast__badge {
        width: 9px;
        height: 9px;
        border-radius: 50%;
        margin-top: 6px;
        flex: 0 0 auto;
    }

    .si-toast__content {
        flex: 1;
        font-size: 13px;
        color: #1f2937;
        line-height: 1.4;
    }

    .si-toast__title {
        font-weight: 800;
        margin-bottom: 2px;
        font-size: 13px;
    }

    .si-toast__close {
        border: 0;
        background: transparent;
        color: #64748b;
        font-size: 16px;
        line-height: 1;
        cursor: pointer;
    }

    .si-toast--success .si-toast__badge { background: #16a34a; }
    .si-toast--error .si-toast__badge { background: #dc2626; }
    .si-toast--warning .si-toast__badge { background: #d97706; }
    .si-toast--info .si-toast__badge { background: #2563eb; }

    .si-confirm-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        z-index: 2300;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
    }

    .si-confirm-modal {
        width: min(420px, 100%);
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 20px 45px rgba(15, 23, 42, 0.2);
        border: 1px solid #e2e8f0;
        overflow: hidden;
    }

    .si-confirm-head {
        padding: 14px 16px;
        border-bottom: 1px solid #e2e8f0;
        font-weight: 800;
        font-size: 15px;
    }

    .si-confirm-body {
        padding: 14px 16px;
        color: #334155;
        font-size: 14px;
    }

    .si-confirm-actions {
        padding: 12px 16px 16px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .si-hidden-flash {
        display: none !important;
    }

    @keyframes si-slide-in {
        from { transform: translateY(-8px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
</style>

<script>
(() => {
    const getToastWrap = () => {
        let wrap = document.querySelector('.si-toast-wrap');
        if (!wrap) {
            wrap = document.createElement('div');
            wrap.className = 'si-toast-wrap';
            document.body.appendChild(wrap);
        }
        return wrap;
    };

    const toastTitle = {
        success: 'Success',
        error: 'Error',
        danger: 'Error',
        warning: 'Warning',
        info: 'Info'
    };

    const showToast = (message, type = 'info', timeout = 4500) => {
        const wrap = getToastWrap();
        const level = ['success', 'error', 'warning', 'info'].includes(type) ? type : 'info';
        const toast = document.createElement('div');
        toast.className = `si-toast si-toast--${level}`;
        toast.innerHTML = `
            <span class="si-toast__badge"></span>
            <div class="si-toast__content">
                <div class="si-toast__title">${toastTitle[type] || toastTitle[level]}</div>
                <div>${message}</div>
            </div>
            <button class="si-toast__close" type="button" aria-label="Close">Ã—</button>
        `;

        toast.querySelector('.si-toast__close')?.addEventListener('click', () => toast.remove());
        wrap.appendChild(toast);
        window.setTimeout(() => toast.remove(), timeout);
    };

    const mapMessage = (field) => {
        if (field.validity.valueMissing) return 'This field is required.';
        if (field.validity.typeMismatch) return 'Please enter a valid value.';
        if (field.validity.patternMismatch) return 'The format is not valid.';
        if (field.validity.rangeOverflow || field.validity.rangeUnderflow) return 'The value is out of allowed range.';
        if (field.validity.tooShort || field.validity.tooLong) return 'The value length is not valid.';
        return field.validationMessage || 'Invalid value.';
    };

    const ensureFeedback = (field) => {
        let fb = field.parentElement?.querySelector('.invalid-feedback.si-generated-feedback');
        if (!fb) {
            fb = document.createElement('div');
            fb.className = 'invalid-feedback si-generated-feedback';
            field.parentElement?.appendChild(fb);
        }
        return fb;
    };

    const validateField = (field) => {
        if (field.disabled || field.type === 'hidden') return true;
        const ok = field.checkValidity();
        field.classList.toggle('is-invalid', !ok);
        field.classList.toggle('is-valid', ok && field.value !== '');
        const feedback = ensureFeedback(field);
        if (!ok) feedback.textContent = mapMessage(field);
        return ok;
    };

    const validateForm = (form) => {
        const fields = Array.from(form.querySelectorAll('input, select, textarea'))
            .filter((el) => ['submit', 'button', 'reset'].includes(el.type) === false);
        let firstInvalid = null;
        let ok = true;
        fields.forEach((field) => {
            const fieldOk = validateField(field);
            if (!fieldOk && !firstInvalid) firstInvalid = field;
            ok = ok && fieldOk;
        });
        if (!ok && firstInvalid) firstInvalid.focus();
        return ok;
    };

    const openConfirm = (message) => new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'si-confirm-overlay';
        overlay.innerHTML = `
            <div class="si-confirm-modal">
                <div class="si-confirm-head">Please confirm</div>
                <div class="si-confirm-body">${message}</div>
                <div class="si-confirm-actions">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-act="cancel">Cancel</button>
                    <button type="button" class="btn btn-danger btn-sm" data-act="ok">Confirm</button>
                </div>
            </div>
        `;
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.remove();
                resolve(false);
            }
        });
        overlay.querySelector('[data-act="cancel"]')?.addEventListener('click', () => {
            overlay.remove();
            resolve(false);
        });
        overlay.querySelector('[data-act="ok"]')?.addEventListener('click', () => {
            overlay.remove();
            resolve(true);
        });
        document.body.appendChild(overlay);
    });

    const bootFlashToasts = () => {
        const flashes = document.querySelectorAll('.flash-item, .js-flash-message');
        flashes.forEach((el) => {
            const text = (el.textContent || '').trim();
            if (!text) return;
            const classes = el.className;
            const level = el.dataset.flashType
                || (classes.includes('success') ? 'success'
                : classes.includes('danger') || classes.includes('error') ? 'error'
                : classes.includes('warning') ? 'warning'
                : 'info');
            showToast(text, level, 5500);
            el.classList.add('si-hidden-flash');
        });
    };

    const bootForms = () => {
        document.querySelectorAll('form').forEach((form) => {
            if (form.dataset.skipGlobalValidation === '1') return;
            if ((form.method || '').toLowerCase() !== 'get') {
                form.setAttribute('novalidate', 'novalidate');
            }

            form.addEventListener('submit', async (event) => {
                const confirmMsg = form.dataset.confirm;
                if (confirmMsg && form.dataset.confirmed !== '1') {
                    event.preventDefault();
                    const ok = await openConfirm(confirmMsg);
                    if (ok) {
                        form.dataset.confirmed = '1';
                        form.requestSubmit();
                    }
                    return;
                }

                if ((form.method || '').toLowerCase() === 'get') return;
                if (!validateForm(form)) {
                    event.preventDefault();
                    showToast('Please correct the highlighted fields before submitting.', 'error');
                }
            });

            form.querySelectorAll('input, select, textarea').forEach((field) => {
                field.addEventListener('blur', () => validateField(field));
            });
        });
    };

    document.querySelectorAll('[data-confirm]').forEach((el) => {
        if (el.tagName.toLowerCase() !== 'form') {
            el.addEventListener('click', async (event) => {
                event.preventDefault();
                const ok = await openConfirm(el.dataset.confirm || 'Are you sure?');
                if (ok) {
                    const form = el.closest('form');
                    if (form) {
                        form.dataset.confirmed = '1';
                        form.requestSubmit();
                    }
                }
            });
        }
    });

    bootFlashToasts();
    bootForms();
})();
</script>

{% if errors is defined and errors %}
    <div class="alert alert-danger" role="alert">
        <ul class="mb-0">
            {% for field, fieldErrors in errors %}
                {% for error in fieldErrors %}
                    <li><strong>{{ field }}:</strong> {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
{% endif %}

{{ form_start(form, {'attr': {'class': 'order-form', 'id': 'admin-order-form'}}) }}

<div class="form-card">
    <h4>Informations client</h4>
    <div class="form-row">
        <div>
            {{ form_row(form.entraineur, {'attr': {'class': 'form-select'}}) }}
        </div>
        <div>
            {{ form_row(form.contactEmail, {'attr': {'class': 'form-control'}}) }}
        </div>
    </div>
    <div class="form-row">
        <div>
            {{ form_row(form.contactPhone, {'attr': {'class': 'form-control'}}) }}
        </div>
        <div>
            {{ form_row(form.orderDate, {'attr': {'class': 'form-control'}}) }}
        </div>
    </div>
    <div class="form-row">
        <div>
            {{ form_row(form.shippingAddress, {'attr': {'class': 'form-control'}}) }}
        </div>
        <div>
            {{ form_row(form.billingAddress, {'attr': {'class': 'form-control'}}) }}
        </div>
    </div>
    <div class="form-row">
        <div>
            {{ form_row(form.status, {'attr': {'class': 'form-select'}}) }}
        </div>
        <div>
            {{ form_row(form.paymentMethod, {'attr': {'class': 'form-select', 'id': 'order_payment_method'}}) }}
        </div>
    </div>
    <div class="form-row">
        <div>
            {{ form_row(form.paymentStatus, {'attr': {'class': 'form-select', 'id': 'order_payment_status'}}) }}
        </div>
    </div>
</div>

<div class="form-card mt-3" id="online-payment-card" style="display:none;">
    <h4>Paiement en ligne (simulation)</h4>
    <div class="form-row">
        <div>
            <label class="form-label" for="card_holder">Nom du porteur</label>
            <input type="text" id="card_holder" name="card_holder" class="form-control" placeholder="Nom complet">
        </div>
        <div>
            <label class="form-label" for="card_number">Numero de carte</label>
            <input type="text" id="card_number" name="card_number" class="form-control" placeholder="16 chiffres" inputmode="numeric" maxlength="19">
        </div>
    </div>
    <div class="form-row">
        <div>
            <label class="form-label" for="card_expiry">Expiration</label>
            <input type="text" id="card_expiry" name="card_expiry" class="form-control" placeholder="MM/YY" maxlength="5">
        </div>
        <div>
            <label class="form-label" for="card_cvv">CVV</label>
            <input type="text" id="card_cvv" name="card_cvv" class="form-control" placeholder="3 ou 4 chiffres" inputmode="numeric" maxlength="4">
        </div>
    </div>
</div>

<div class="form-card mt-3">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h4 style="margin:0;">Produits command√©s</h4>
        <button type="button" class="btn btn-outline-primary btn-sm" id="add-item-btn">Ajouter produit</button>
    </div>

    <div id="order-items"
         data-index="{{ form.items|length }}"
         data-prototype="{{ form_widget(form.items.vars.prototype)|e('html_attr') }}">
        {% for itemForm in form.items %}
            <div class="item-line border rounded p-3 mb-2">
                <div class="form-row">
                    <div>{{ form_row(itemForm.product, {'attr': {'class': 'form-select product-select'}}) }}</div>
                    <div>{{ form_row(itemForm.quantity, {'attr': {'class': 'form-control qty-input', 'min': 1}}) }}</div>
                </div>
                {{ form_widget(itemForm.unitPrice, {'attr': {'class': 'unit-price'}}) }}
                <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn mt-2">Supprimer</button>
            </div>
        {% endfor %}
    </div>

    <div class="mt-3" style="font-size:18px; font-weight:700;">
        Total: <span id="order-total">$0.00</span>
    </div>
</div>

<div class="form-actions mt-3">
    <button type="submit" class="btn btn-primary">Enregistrer</button>
    <a href="{{ path('app_order_index') }}" class="btn btn-secondary">Annuler</a>
</div>

{{ form_end(form) }}

<style>
    .form-card {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
    }
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }
    .form-actions {
        display: flex;
        gap: 10px;
    }
    @media (max-width: 900px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
(() => {
    const itemsContainer = document.getElementById('order-items');
    const addBtn = document.getElementById('add-item-btn');
    const totalEl = document.getElementById('order-total');
    const paymentMethod = document.getElementById('order_payment_method');
    const paymentStatus = document.getElementById('order_payment_status');
    const onlinePaymentCard = document.getElementById('online-payment-card');

    if (!itemsContainer || !addBtn || !totalEl) {
        return;
    }

    const togglePayment = () => {
        if (!paymentMethod || !onlinePaymentCard) {
            return;
        }
        const isOnline = paymentMethod.value === 'online';
        onlinePaymentCard.style.display = isOnline ? 'block' : 'none';
        if (paymentStatus) {
            paymentStatus.value = isOnline ? 'paid' : 'pending';
        }
    };

    const bindLine = (line) => {
        const removeBtn = line.querySelector('.remove-item-btn');
        const productSelect = line.querySelector('.product-select');
        const qtyInput = line.querySelector('.qty-input');
        const unitPriceInput = line.querySelector('.unit-price');

        if (removeBtn) {
            removeBtn.addEventListener('click', () => {
                line.remove();
                refreshTotal();
            });
        }

        if (productSelect) {
            productSelect.addEventListener('change', () => {
                const selected = productSelect.options[productSelect.selectedIndex];
                const price = selected ? selected.getAttribute('data-price') : '0';
                if (unitPriceInput) {
                    unitPriceInput.value = price || '0';
                }
                refreshTotal();
            });
        }

        if (qtyInput) {
            qtyInput.addEventListener('input', refreshTotal);
        }
    };

    const refreshTotal = () => {
        let total = 0;
        itemsContainer.querySelectorAll('.item-line').forEach((line) => {
            const qty = parseInt(line.querySelector('.qty-input')?.value || '0', 10);
            const price = parseFloat(line.querySelector('.unit-price')?.value || '0');
            if (!isNaN(qty) && !isNaN(price)) {
                total += qty * price;
            }
        });
        totalEl.textContent = '$' + total.toFixed(2);
    };

    addBtn.addEventListener('click', () => {
        const index = parseInt(itemsContainer.dataset.index || '0', 10);
        const tpl = itemsContainer.dataset.prototype.replace(/__name__/g, index);

        const wrapper = document.createElement('div');
        wrapper.className = 'item-line border rounded p-3 mb-2';
        wrapper.innerHTML = tpl + '<button type="button" class="btn btn-sm btn-outline-danger remove-item-btn mt-2">Supprimer</button>';

        itemsContainer.appendChild(wrapper);
        itemsContainer.dataset.index = String(index + 1);
        bindLine(wrapper);
        refreshTotal();
    });

    itemsContainer.querySelectorAll('.item-line').forEach(bindLine);
    refreshTotal();
    togglePayment();

    if (paymentMethod) {
        paymentMethod.addEventListener('change', togglePayment);
    }
})();
</script>
